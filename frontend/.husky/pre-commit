#!/bin/sh
set -e

# Frontend: lint-staged (Biome) - auto-formats JS/TS files
cd frontend && npx lint-staged
cd ..

# Backend: Ruff via Docker (only if Python files changed)
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' | grep '^backend/' || true)
if [ -n "$PYTHON_FILES" ]; then
  echo "üîç Running Ruff on staged Python files..."

  # Check that backend container is running
  if ! docker compose ps --status running 2>/dev/null | grep -q backend; then
    echo "‚ùå Error: Backend container is not running"
    echo "   Please run 'make up' first to start Docker containers"
    exit 1
  fi

  # Convert to paths relative to backend/
  RELATIVE_FILES=$(echo "$PYTHON_FILES" | sed 's|^backend/||' | tr '\n' ' ')

  # Auto-fix linting issues and format
  docker compose exec -T backend ruff check --fix $RELATIVE_FILES
  docker compose exec -T backend ruff format $RELATIVE_FILES

  # Re-add formatted files to staging
  echo "$PYTHON_FILES" | xargs git add
fi
