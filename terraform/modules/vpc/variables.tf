# =============================================================================
# ПЕРЕМЕННЫЕ VPC МОДУЛЯ
# =============================================================================
#
# Переменные позволяют настраивать модуль без изменения кода.
# При вызове модуля значения передаются через блок module { ... }
#
# Каждая переменная имеет:
# - description: описание для документации и CLI
# - type: тип данных (string, number, bool, list, map)
# - default: значение по умолчанию (опционально)
# - validation: правила валидации (опционально)
# =============================================================================

# -----------------------------------------------------------------------------
# Основные настройки проекта
# -----------------------------------------------------------------------------

variable "project_name" {
  description = <<-EOT
    Имя проекта. Используется для формирования имён ресурсов.
    Например: tutors → tutors-prod-vpc, tutors-prod-public-1

    Рекомендации:
    - Используйте короткие имена (3-15 символов)
    - Только буквы нижнего регистра, цифры и дефисы
    - Начинайте с буквы
  EOT
  type        = string

  validation {
    condition     = can(regex("^[a-z][a-z0-9-]{2,14}$", var.project_name))
    error_message = "Project name must be 3-15 characters, start with a letter, and contain only lowercase letters, numbers, and hyphens."
  }
}

variable "environment" {
  description = <<-EOT
    Окружение: prod, staging, dev
    Используется для разделения ресурсов и тегирования.

    Рекомендации:
    - prod: production, минимальные изменения, максимальная надёжность
    - staging: точная копия prod для тестирования
    - dev: для разработки, можно экспериментировать
  EOT
  type        = string

  validation {
    condition     = contains(["prod", "staging", "dev"], var.environment)
    error_message = "Environment must be one of: prod, staging, dev."
  }
}

# -----------------------------------------------------------------------------
# Сетевые настройки
# -----------------------------------------------------------------------------

variable "vpc_cidr" {
  description = <<-EOT
    CIDR блок для VPC. Определяет диапазон IP адресов внутри VPC.

    Что такое CIDR?
    CIDR (Classless Inter-Domain Routing) - нотация для описания диапазонов IP.
    Формат: IP/маска, где маска определяет количество адресов.

    Примеры:
    - 10.0.0.0/16 → 65,536 адресов (10.0.0.0 - 10.0.255.255)
    - 10.0.0.0/24 → 256 адресов (10.0.0.0 - 10.0.0.255)
    - 10.0.0.0/8  → 16,777,216 адресов

    Рекомендации:
    - Для production используйте /16 (достаточно для роста)
    - Не пересекайтесь с другими VPC если планируете VPC Peering
    - Используйте приватные диапазоны: 10.x.x.x, 172.16-31.x.x, 192.168.x.x
  EOT
  type        = string
  default     = "10.0.0.0/16"

  validation {
    # Проверяем, что это валидный CIDR в приватном диапазоне
    condition = can(cidrhost(var.vpc_cidr, 0)) && (
      startswith(var.vpc_cidr, "10.") ||
      startswith(var.vpc_cidr, "172.") ||
      startswith(var.vpc_cidr, "192.168.")
    )
    error_message = "VPC CIDR must be a valid private IP range (10.x.x.x, 172.16-31.x.x, or 192.168.x.x)."
  }
}

variable "create_nat_gateway" {
  description = <<-EOT
    Создавать ли NAT Gateway для исходящего трафика приватных подсетей.

    NAT Gateway нужен если ресурсы в приватных подсетях должны:
    - Скачивать Docker образы из ECR
    - Делать API запросы к внешним сервисам
    - Скачивать пакеты (pip, npm, apt)

    ВАЖНО: NAT Gateway стоит ~$32/месяц + $0.045/GB трафика!

    Альтернативы для экономии:
    - VPC Endpoints для AWS сервисов (ECR, S3) - $7/месяц за endpoint
    - NAT Instance (EC2 t3.micro) - ~$5/месяц
    - Разместить ECS в публичных подсетях (менее безопасно)

    Для dev окружения можно отключить (false) и использовать endpoints.
    Для prod рекомендуется включить (true) для надёжности.
  EOT
  type        = bool
  default     = true
}

# -----------------------------------------------------------------------------
# Дополнительные настройки (опциональные)
# -----------------------------------------------------------------------------

variable "tags" {
  description = <<-EOT
    Дополнительные теги для всех ресурсов модуля.
    Объединяются со стандартными тегами (Name, Project, Environment).

    Пример использования:
    tags = {
      CostCenter = "engineering"
      Team       = "platform"
    }
  EOT
  type        = map(string)
  default     = {}
}
